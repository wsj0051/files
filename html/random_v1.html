<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>ç‚¹åå™¨</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root{
  --bg:#f5f7fa;
  --card:#ffffff;
  --text:#333;
  --primary:#4f7cff;
  --name-bg:#eee;
  --shadow: 0 6px 16px rgba(0,0,0,.08);
}
[data-theme="dark"]{
  --bg:#1e1f22;
  --card:#2a2b2f;
  --text:#eee;
  --primary:#4f7cff;
  --name-bg:#444;
  --shadow: 0 6px 16px rgba(0,0,0,.2);
}
[data-theme="green"]{
  --bg:#f0f7f2;
  --card:#ffffff;
  --text:#333;
  --primary:#3ba776;
  --name-bg:#eee;
  --shadow: 0 6px 16px rgba(0,0,0,.08);
}

body{
  margin:0;
  background:var(--bg);
  font-family:system-ui, sans-serif;
  color:var(--text);
  transition: background 0.3s ease;
}
.container{
  max-width:900px;
  margin:auto;
  padding:16px;
}
.card{
  background:var(--card);
  border-radius:12px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:var(--shadow);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(0,0,0,.12);
}
.row{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:center;
}
button,select,input{
  padding:8px 12px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:14px;
  transition: all 0.2s ease;
}
button{background:var(--primary);color:#fff;border:none;cursor:pointer}
button.secondary{background:#888;}
button:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 8px rgba(0,0,0,.1);
}
button:active {
  transform: scale(0.95);
}
.names{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(80px,1fr));
  gap:6px;
  opacity: 0;
  animation: fadeInNames 0.5s ease forwards;
}
@keyframes fadeInNames {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
.name{
  padding:6px;
  text-align:center;
  border-radius:6px;
  background:var(--name-bg);
  color:var(--text);
  cursor:pointer;
  transition: transform 0.2s ease, background 0.2s ease;
  animation: popIn 0.3s ease;
}
@keyframes popIn {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
.name.used{
  text-decoration:line-through;
  opacity:.5;
  background: #ddd;
}
.name:hover{
  transform:scale(1.1) rotate(2deg);
  box-shadow: 0 4px 8px rgba(0,0,0,.1);
}
.popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
  animation:fadeIn 0.3s ease;
}
.popup-content{
  background:var(--card);
  padding:24px;
  border-radius:16px;
  font-size:26px;
  text-align:center;
  position:relative;
  transform: scale(0.8);
  opacity: 0;
  animation: zoomIn 0.4s ease forwards;
}
@keyframes zoomIn {
  from { transform: scale(0.8) rotate(-5deg); opacity: 0; }
  to { transform: scale(1) rotate(0); opacity: 1; }
}
.popup-content span{
  display:block;
  margin:8px 0;
  color:var(--primary);
  font-weight:bold;
  font-size:32px;
  animation: glow 1.5s infinite alternate;
}
@keyframes glow {
  0% { text-shadow: 0 0 5px var(--primary); }
  100% { text-shadow: 0 0 15px var(--primary); }
}
@keyframes fadeIn{
  0%{opacity:0;}
  100%{opacity:1;}
}

/* ç‚¹åè§„åˆ™å¸ƒå±€ */
.rules{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-top:10px;
}
.rule-item{
  display:flex;
  align-items:center;
  gap:6px;
  background:#f2f4f8;
  padding:6px 10px;
  border-radius:8px;
  font-size:14px;
  transition: background 0.2s ease;
}
.rule-item:hover {
  background: #e0e4ec;
}
.hint{
  font-size:13px;
  color:#888;
  transition: color 0.3s ease;
}
</style>
</head>

<body>
<canvas id="explosionCanvas" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:999;"></canvas>
<div class="container">

<!-- ç­çº§é€‰æ‹© + ç‚¹åè§„åˆ™ -->
<div class="card">
  <h3>ğŸ“˜ ç­çº§ä¸ç‚¹åè§„åˆ™</h3>
  <div class="row">
    <label>ç­çº§ 
      <select id="classSelect"></select>
    </label>
    <label>äººæ•° 
      <input id="count" type="number" value="1" min="1">
    </label>
    <label><input type="checkbox" id="repeat" checked> å…è®¸é‡å¤</label>
    <label><input type="checkbox" id="voice" checked> è¯­éŸ³æ’­æŠ¥</label>
    <label>ä¸»é¢˜
      <select id="theme">
        <option value="">æµ…è‰²</option>
        <option value="dark">æ·±è‰²</option>
        <option value="green">æŠ¤çœ¼</option>
      </select>
    </label>
  </div>
  <div class="hint">ç­çº§é€šè¿‡ Excel å¯¼å…¥ç®¡ç†</div>
</div>

<!-- æ“ä½œæŒ‰é’® -->
<div class="card">
  <div class="row">
    <button onclick="start()">â–¶ å¼€å§‹ç‚¹å</button>
    <button class="secondary" onclick="resetUsed()">ğŸ”„ é‡ç½®å·²ç‚¹</button>
    <button onclick="exportExcel()">å¯¼å‡ºExcel</button>
    <input type="file" id="file" hidden>
    <button onclick="document.getElementById('file').click()">å¯¼å…¥Excel</button>
    <button onclick="showHelp()">â“ ä½¿ç”¨è¯´æ˜</button>
  </div>
</div>

<!-- å­¦ç”Ÿåå•æ˜¾ç¤º -->
<div class="card">
  <h3>ğŸ‘¥ åå•ï¼ˆç‚¹å‡»å¯æ ‡è®°å·²ç‚¹ï¼‰</h3>
  <div class="names" id="names"></div>
</div>

</div>

<!-- ç‚¹åç»“æœå¼¹æ¡† -->
<div class="popup" id="popup" onclick="hidePopup()">
  <div class="popup-content" id="popupText"></div>
</div>

<!-- ä½¿ç”¨è¯´æ˜å¼¹æ¡† -->
<div class="popup" id="helpPopup" onclick="hideHelp()">
  <div class="popup-content" style="max-width:520px;font-size:14px;text-align:left"
       onclick="event.stopPropagation()">
    <h3>ğŸ“˜ ç‚¹åå™¨ä½¿ç”¨è¯´æ˜</h3>
    <p><b>ä¸€ã€Excel æ•°æ®æ ¼å¼</b></p>
    <ul>
      <li>ä¸€ä¸ª Sheet è¡¨ç¤ºä¸€ä¸ªç­çº§</li>
      <li>Sheet åç§° = ç­çº§åç§°</li>
      <li>ç¬¬ä¸€è¡Œä¸ºè¡¨å¤´ï¼ˆå†™ï¼šå§“åï¼‰</li>
      <li>ç¬¬ä¸€åˆ—å¡«å†™å§“å</li>
    </ul>
    <p><b>äºŒã€å¯¼å…¥è§„åˆ™ï¼ˆé‡è¦ï¼‰</b></p>
    <ul>
      <li>å¯¼å…¥ Excel åï¼Œä¼š <b>å®Œå…¨æ›¿æ¢</b> å½“å‰æ‰€æœ‰ç­çº§</li>
      <li>åŸæœ‰ç­çº§å’Œç‚¹åè®°å½•å°†è¢«æ¸…ç©º</li>
      <li>å»ºè®®å¯¼å…¥å‰å…ˆå¯¼å‡ºå¤‡ä»½</li>
    </ul>
    <p><b>ä¸‰ã€å¯¼å‡ºè¯´æ˜</b></p>
    <ul>
      <li>å¯¼å‡ºä¸ºä¸€ä¸ª Excel æ–‡ä»¶</li>
      <li>æ¯ä¸ªç­çº§å•ç‹¬ä¸€ä¸ª Sheet</li>
      <li>ä»…å¯¼å‡ºå­¦ç”Ÿåå•ï¼ˆä¸åŒ…å«ç‚¹åçŠ¶æ€ï¼‰</li>
    </ul>
    <p><b>å››ã€ç‚¹åæµç¨‹</b></p>
    <ol>
      <li>é€‰æ‹©ç­çº§</li>
      <li>è®¾ç½®äººæ•° / æ˜¯å¦é‡å¤ / è¯­éŸ³æ’­æŠ¥ / ä¸»é¢˜</li>
      <li>ç‚¹å‡»ã€Œå¼€å§‹ç‚¹åã€</li>
    </ol>
    <p style="text-align:center;color:#888;margin-top:10px">
      ç‚¹å‡»ç©ºç™½å¤„å…³é—­è¯´æ˜
    </p>
  </div>
</div>

<script>
/* ===== æ•°æ® ===== */
const KEY="rollcall_v5";
let store=JSON.parse(localStorage.getItem(KEY))||{
  classes:[{
    name:"ç¤ºä¾‹ç­çº§",
    students:Array.from({length:30},(_,i)=>"å­¦ç”Ÿ"+(i+1)),
    used:[]
  }],
  selectedIdx: 0,
  theme: "",
  count: 1,
  repeat: true,
  voice: true
};
let idx=0;

/* ===== DOM ===== */
const classSelect=document.getElementById("classSelect");
const namesEl=document.getElementById("names");
const popup=document.getElementById("popup");
const popupText=document.getElementById("popupText");
const countEl=document.getElementById("count");
const repeatEl=document.getElementById("repeat");
const voiceEl=document.getElementById("voice");
const themeEl=document.getElementById("theme");
const fileEl=document.getElementById("file");

/* ===== åˆå§‹åŒ– ===== */
function init(){
  classSelect.innerHTML="";
  store.classes.forEach((c,i)=>{
    if(!Array.isArray(c.used)) c.used=[];
    const o=document.createElement("option");
    o.value=i;o.textContent=c.name;
    classSelect.appendChild(o);
  });
  idx = store.selectedIdx || 0;
  if (idx >= store.classes.length) idx = 0;
  classSelect.value=idx;
  themeEl.value = store.theme || "";
  document.body.dataset.theme = store.theme || "";
  countEl.value = store.count || 1;
  repeatEl.checked = store.repeat !== undefined ? store.repeat : true;
  voiceEl.checked = store.voice !== undefined ? store.voice : true;
  renderNames();
}
classSelect.onchange=e=>{
  idx=+e.target.value; 
  store.selectedIdx = idx; 
  renderNames(); 
  save();
};

/* ===== æ¸²æŸ“åå• ===== */
function renderNames(){
  const c=store.classes[idx];
  namesEl.innerHTML="";
  c.students.forEach((n,i)=>{
    const d=document.createElement("div");
    d.className="name"+(c.used.includes(i)?" used":"");
    d.textContent=n;
    d.onclick=()=>{ 
      if(c.used.includes(i)){
        c.used=c.used.filter(x=>x!==i);
      }else{
        c.used.push(i);
      }
      renderNames();
      save();
    };
    namesEl.appendChild(d);
  });
  // è§¦å‘åŠ¨ç”»ï¼šç§»é™¤å¹¶é‡æ–°æ·»åŠ ç±»ä»¥é‡ç½®åŠ¨ç”»
  namesEl.style.animation = 'none';
  namesEl.offsetHeight; // è§¦å‘é‡ç»˜
  namesEl.style.animation = '';
}

/* ===== ç‚¹å ===== */
function start(){
  const c=store.classes[idx];
  const num=+countEl.value;
  const allow=repeatEl.checked;
  let pool=c.students.map((_,i)=>i).filter(i=>allow||!c.used.includes(i));
  if(pool.length===0) return alert("æ²¡äººå¯ç‚¹äº†");

  let res=[];
  for(let i=0;i<num&&pool.length;i++){
    const r=pool.splice(Math.random()*pool.length|0,1)[0];
    res.push(r);
    if(!allow) c.used.push(r);
  }
  showPopup(res.map(i=>c.students[i]));
  if(voiceEl.checked) speak(res.map(i=>c.students[i]).join("ã€"));
  renderNames();
  save();
}

/* ===== å¼¹æ¡† ===== */
function showPopup(list){
  popupText.innerHTML=list.map(n=>`<span>${n}</span>`).join("");
  popup.style.display="flex";
  triggerExplosion(); // è§¦å‘ç²’å­çˆ†ç‚¸
}
function hidePopup(){popup.style.display="none"}

/* ===== è¯­éŸ³ ===== */
function speak(t){
  const u=new SpeechSynthesisUtterance(t);
  u.lang="zh-CN";
  speechSynthesis.speak(u);
}

/* ===== Excel å¯¼å…¥å¯¼å‡º ===== */
function exportExcel(){
  const wb=XLSX.utils.book_new();
  store.classes.forEach(c=>{
    const ws=XLSX.utils.aoa_to_sheet([["å§“å"], ...c.students.map(s=>[s])]);
    XLSX.utils.book_append_sheet(wb, ws, c.name);
  });
  XLSX.writeFile(wb,"ç‚¹åæ•°æ®.xlsx");
}
fileEl.onchange=e=>{
  const r=new FileReader();
  r.onload=()=>{
    const wb=XLSX.read(r.result,{type:"binary"});
    store.classes=wb.SheetNames.map(n=>{
      const a=XLSX.utils.sheet_to_json(wb.Sheets[n],{header:1}).slice(1);
      return {name:n, students:a.map(x=>x[0]).filter(Boolean), used:[]}; // è¿‡æ»¤ç©ºå§“å
    }).filter(c => c.students.length > 0); // è¿‡æ»¤ç©ºç­çº§
    idx=0;
    store.selectedIdx = 0;
    init();
    save();
  };
  r.readAsBinaryString(e.target.files[0]);
};

/* ===== ä¸»é¢˜åˆ‡æ¢ & å…¶ä»–è®¾ç½® & å­˜å‚¨ ===== */
themeEl.onchange=e=>{
  document.body.dataset.theme=e.target.value;
  store.theme = e.target.value;
  save();
};
countEl.onchange=()=>{ 
  store.count = +countEl.value; 
  save(); 
};
repeatEl.onchange=()=>{ 
  store.repeat = repeatEl.checked; 
  save(); 
};
voiceEl.onchange=()=>{ 
  store.voice = voiceEl.checked; 
  save(); 
};
function save(){localStorage.setItem(KEY,JSON.stringify(store))}

/* ===== ä½¿ç”¨è¯´æ˜ ===== */
function showHelp(){document.getElementById("helpPopup").style.display="flex";}
function hideHelp(){document.getElementById("helpPopup").style.display="none";}

/* ===== é‡ç½®å·²ç‚¹ ===== */
function resetUsed(){
  if (confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰å·²ç‚¹åçŠ¶æ€å—ï¼Ÿ")) {
    store.classes[idx].used = [];
    renderNames();
    save();
  }
}

/* ===== ç²’å­çˆ†ç‚¸åŠ¨ç”» ===== */
let particles = [];
class Particle {
  constructor(x, y, radius, dx, dy, color) {
    this.x = x;
    this.y = y;
    this.radius = radius;
    this.dx = dx;
    this.dy = dy;
    this.alpha = 1;
    this.color = color;
  }
  draw(ctx) {
    ctx.save();
    ctx.globalAlpha = this.alpha;
    ctx.fillStyle = this.color;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
    ctx.fill();
    ctx.restore();
  }
  update(ctx) {
    this.draw(ctx);
    this.alpha -= 0.01;
    this.x += this.dx;
    this.y += this.dy;
  }
}

const explosionCanvas = document.getElementById("explosionCanvas");
explosionCanvas.height = window.innerHeight;
explosionCanvas.width = window.innerWidth;
const expCtx = explosionCanvas.getContext("2d");

function triggerExplosion() {
  particles = [];
  const centerX = window.innerWidth / 2;
  const centerY = window.innerHeight / 2;
  const particleCount = 150;
  const colors = ['#4f7cff', '#ff4f7c', '#7cff4f', '#ffff4f']; // å¤šé¢œè‰²ç²’å­

  for (let i = 0; i < particleCount; i++) {
    const dx = (Math.random() - 0.5) * (Math.random() * 8);
    const dy = (Math.random() - 0.5) * (Math.random() * 8);
    const radius = Math.random() * 4 + 1;
    const color = colors[Math.floor(Math.random() * colors.length)];
    particles.push(new Particle(centerX, centerY, radius, dx, dy, color));
  }
  explode();
}

function explode() {
  expCtx.clearRect(0, 0, explosionCanvas.width, explosionCanvas.height);
  particles.forEach((particle, i) => {
    if (particle.alpha <= 0) {
      particles.splice(i, 1);
    } else {
      particle.update(expCtx);
    }
  });
  if (particles.length > 0) {
    requestAnimationFrame(explode);
  }
}

/* ===== åˆå§‹åŒ– ===== */
init();
</script>
</body>
</html>